<!DOCTYPE html>
<html>
<%
const homeComp = gameData.gameInfo.competitors[0];
const awayComp = gameData.gameInfo.competitors[1];
const homeTeam = homeComp.team;
const awayTeam = awayComp.team;

function getNumberWithOrdinal(n) {
    var s = ["th", "st", "nd", "rd"],
        v = n % 100;
    return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function formatYardline(yardsToEndzone, offenseAbbrev, defenseAbbrev) {
    if (yardsToEndzone == 50) {
        return "50";
    } else if (yardsToEndzone < 50) {
        return `${defenseAbbrev} ${yardsToEndzone}`
    } else {
        return `${offenseAbbrev} ${100 - yardsToEndzone}`
    }
}

function formatDistance(distance) {
    return (distance == 0) ? "Goal" : distance
}

%>
<%- include('../partials/head') %> 
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="#">
                                <span data-feather="home"></span>
                                Box Score
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file"></span>
                                Orders
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="shopping-cart"></span>
                                Products
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="users"></span>
                                Customers
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="bar-chart-2"></span>
                                Reports
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="layers"></span>
                                Integrations
                            </a>
                        </li>
                    </ul>
                    
                    <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-muted">
                        <span>Saved reports</span>
                        <a class="link-secondary" href="#" aria-label="Add a new report">
                            <span data-feather="plus-circle"></span>
                        </a>
                    </h6>
                    <ul class="nav flex-column mb-2">
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file-text"></span>
                                Current month
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file-text"></span>
                                Last quarter
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file-text"></span>
                                Social engagement
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">
                                <span data-feather="file-text"></span>
                                Year-end sale
                            </a>
                        </li>
                    </ul>
                </div>
            </nav> -->
            
            <main class="col-md-12 ms-sm-auto col-lg-12 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <div>
                        <h1 class="h2"><%= awayTeam.nickname %> <%= awayComp.score %>, <%= homeTeam.nickname %> <%= homeComp.score %></h1>
                        <p class="text-small" id="game-date"></p>
                    </div>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <a class="btn btn-sm btn-outline-primary" href="https://collegefootballdata.com/boxscore/<%= gameData.gameInfo.id %>">Box Score</a>
                            <a href="#myChart" class="btn btn-sm btn-outline-primary">WP Chart</a>
                            <a href="#scoring-plays" class="btn btn-sm btn-outline-primary">Scoring Plays</a>
                            <a href="#all-plays" class="btn btn-sm btn-outline-primary">All Plays</a>
                            <a class="btn btn-sm btn-outline-primary" href="https://www.espn.com/college-football/game/_/gameId/<%= gameData.gameInfo.id %>">ESPN</a>
                        </div>
                    </div>
                </div>
                
                <canvas class="my-4 w-100" id="myChart" width="900" height="380"></canvas>
                
                <h2 id="scoring-plays">Scoring Plays</h2>
                <div class="table-responsive">
                    <% if (gameData.scoringPlays != null && gameData.scoringPlays.length > 0) { %>
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th align="left">Time</th>
                                    <th align="center">Offense</th>
                                    <th align="left">Play Description</th>
                                    <th align="center">EPA</th>
                                    <th align="center">WP%</th>
                                    <th align="right">WPA</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% gameData.scoringPlays.forEach(play => { %>
                                    <tr>
                                        <% 
                                            var period = `Q${play.period}`;
                                            if (play.period > 5) {
                                                period = `${play.period - 4}OT`
                                            } else if (play.period == 5) {
                                                period = "OT"
                                            } else {
                                                period = `Q${play.period} ${play.clock.displayValue}`;
                                            }

                                            var offense = (play.start.team.id == homeTeam.id) ? homeTeam : awayTeam;
                                            var defense = (play.start.team.id == homeTeam.id) ? awayTeam : homeTeam;
                                        %>
                                        <td align="left"><%= period %></td>
                                        <td align="center"><img class="img-fluid" width="35px" src="https://a.espncdn.com/i/teamlogos/ncaa/500/<%= play.start.team.id %>.png" alt="ESPN team id <%= play.start.team.id %>"/></td>
                                        <td align="left">(<%= getNumberWithOrdinal(play.start.down) %> & <%= formatDistance(play.start.distance) %> at <%= formatYardline(play.start.yardsToEndzone, offense.abbreviation, defense.abbreviation) %>) <%= play.text %></td>
                                        
                                        <td align="center"><%= (Math.round(play.expectedPoints.added * 100) / 100).toPrecision(3) %></td>
                                        <td align="center"><%= ((Math.round(play.winProbability.before * 1000) / 1000) * 100).toPrecision(3) %>%</td>
                                        <td align="right"><%= ((Math.round(play.winProbability.added * 1000) / 1000) * 100).toPrecision(3) %>%</td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p class="text-center">No scoring plays in this game.</p>
                    <% } %>
                </div>

                <h2 id="all-plays">All Plays</h2>
                <div class="table-responsive">
                    <% if (gameData.plays != null && gameData.plays.length > 0) { %>
                        <table class="table table-striped table-sm">
                            <thead>
                                <tr>
                                    <th align="left">Time</th>
                                    <th align="center">Offense</th>
                                    <th align="left">Play Description</th>
                                    <th align="center">EPA</th>
                                    <th align="center">WP%</th>
                                    <th align="right">WPA</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% gameData.plays.forEach(play => { %>
                                    <tr>
                                        <% 
                                            var period = `Q${play.period}`;
                                            if (play.period > 5) {
                                                period = `${play.period - 4}OT`
                                            } else if (play.period == 5) {
                                                period = "OT"
                                            } else {
                                                period = `Q${play.period} ${play.clock.displayValue}`;
                                            }

                                            var offense = (play.start.team.id == homeTeam.id) ? homeTeam : awayTeam;
                                            var defense = (play.start.team.id == homeTeam.id) ? awayTeam : homeTeam;
                                        %>
                                        <td align="left"><%= period %></td>
                                        <td align="center"><img class="img-fluid" width="35px" src="https://a.espncdn.com/i/teamlogos/ncaa/500/<%= play.start.team.id %>.png" alt="ESPN team id <%= play.start.team.id %>"/></td>
                                        <td align="left">(<%= getNumberWithOrdinal(play.start.down) %> & <%= formatDistance(play.start.distance) %> at <%= formatYardline(play.start.yardsToEndzone, offense.abbreviation, defense.abbreviation) %>) <%= play.text %></td>
                                        
                                        
                                        <td align="center"><%= (Math.round(play.expectedPoints.added * 100) / 100).toPrecision(3) %></td>
                                        <td align="center"><%= ((Math.round(play.winProbability.before * 1000) / 1000) * 100).toPrecision(3) %>%</td>
                                        <td align="right"><%= ((Math.round(play.winProbability.added * 1000) / 1000) * 100).toPrecision(3) %>%</td>
                                    </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    <% } else { %>
                        <p class="text-center">No plays in this game.</p>
                    <% } %>
                </div>
                <!-- <p id="content"></p> -->
            </main>
        </div>
    </div>
    
    <link href="/assets/css/dashboard.css" rel="stylesheet">
    <link href="/assets/css/blog.css" rel="stylesheet">
    <%- include('../partials/scripts') %>        
    <script src="https://cdn.jsdelivr.net/npm/feather-icons@4.28.0/dist/feather.min.js" integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha384-zNy6FEbO50N+Cg5wap8IKA4M/ZnLJgzc6w2NqACZaK0u0FXfOWRRJOnQtpZun8ha" crossorigin="anonymous"></script>
    <script>
        const DateTime = luxon.DateTime;
        var gameData = <%- JSON.stringify(gameData) %>;
        // document.body.querySelector("#content").innerHTML = "<pre>" + JSON.stringify(gameData, null, 2) +  "</pre>";
        document.body.querySelector("#game-date").innerText = DateTime.fromISO(gameData.gameInfo.date).toLocaleString(DateTime.DATETIME_FULL);
      </script>
    </script>
    <script src="/assets/js/dashboard.js"></script>
</body>
</html>